<!DOCTYPE html>
<head>
    <meta charset="utf-8">

    <!--Import Google Icon Font-->
    <link href="http://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!--Import materialize.css-->
    <link type="text/css" rel="stylesheet" href="css/materialize.min.css" media="screen,projection"/>
    <!--Let browser know website is optimized for mobile-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

    <script src="js/d3.min.js"></script>
    <script src="http://labratrevenge.com/d3-tip/javascripts/d3.tip.v0.6.3.js"></script>

    <script>

        function fillStatistics(data) {
            var divtable = document.getElementById('statistics_table');
            var table = document.createElement('table');
            var thead = document.createElement('thead');
            var tr = document.createElement('tr');

            while (divtable.hasChildNodes()) {
                divtable.removeChild(divtable.lastChild);
            }

			/*
            data.sort(function(a, b){
                if(a.name < b.name) return -1;
                if(a.name > b.name) return 1;
                return 0;
            });
			*/

            //tr.appendChild(document.createElement('th'));
            thead.appendChild(tr);
            table.appendChild(thead);

            // Header
            var header = ["Game", "Vertices", "Edges", "Min Degree", "Max Degree", "Average Degree", "Self Loops"];
            var th = document.createElement('th');
            th.appendChild(document.createTextNode(header[0]));
            tr.appendChild(th);
            for (var i = 1; i < header.length; i++) {
                var th = document.createElement('th');
                th.appendChild(document.createTextNode(header[i]));
                th.setAttribute('style', 'text-align: right');
                tr.appendChild(th);
            }

            var tbody = document.createElement('tbody');
            table.appendChild(tbody);

            console.log(data);

            // Content
            for (var n = 0; n < data.length; n++) {
                tr = document.createElement('tr');
                td = document.createElement('td');
                td.appendChild(document.createTextNode(data[n].name));
                tr.appendChild(td);
                td = document.createElement('td');
                td.appendChild(document.createTextNode(data[n].vertices));
                td.setAttribute('style', 'text-align: right');
                tr.appendChild(td);
                td = document.createElement('td');
                td.appendChild(document.createTextNode(data[n].edges));
                td.setAttribute('style', 'text-align: right');
                tr.appendChild(td);
                td = document.createElement('td');
                td.appendChild(document.createTextNode(data[n].mindegree));
                td.setAttribute('style', 'text-align: right');
                tr.appendChild(td);
                td = document.createElement('td');
                td.appendChild(document.createTextNode(data[n].maxdegree));
                td.setAttribute('style', 'text-align: right');
                tr.appendChild(td);
                td = document.createElement('td');
                td.appendChild(document.createTextNode(data[n].avgdegree));
                td.setAttribute('style', 'text-align: right');
                tr.appendChild(td);
				td = document.createElement('td');
                td.appendChild(document.createTextNode(data[n].selfloops));
                td.setAttribute('style', 'text-align: right');
                tr.appendChild(td);
                tbody.appendChild(tr);
            }

            table.setAttribute('class', 'striped');
            divtable.appendChild(table);
        }

        function getStrategies(data) {
            var strategies = [];
            for (var i = 0; i < data.length; i++) {
                var found = false;

                for (var n = 0; n < strategies.length; n++) {
                    if (data[i].strategy == strategies[n]) {
                        found = true;
                    }
                }

                if (!found) {
                    strategies.push(data[i].strategy);
                }
            }
            return strategies;
        }

        function getGames(data) {
            var games = [];
            for (var i = 0; i < data.length; i++) {
                var found = false;

                for (var n = 0; n < games.length; n++) {
                    if (data[i].game == games[n]) {
                        found = true;
                    }
                }

                if (!found) {
                    games.push(data[i].game);
                }
            }

			/*
            games.sort(function(a, b){
                if(a < b) return -1;
                if(a > b) return 1;
                return 0;
            })
			*/

            return games;
        }

        function fillIterationTable(data) {

            var strategies = getStrategies(data);
            var games = getGames(data);

            var divtable = document.getElementById('iteration_table');
            var table = document.createElement('table');
            var thead = document.createElement('thead');
            var tr = document.createElement('tr');

            while (divtable.hasChildNodes()) {
                divtable.removeChild(divtable.lastChild);
            }

            tr.appendChild(document.createElement('th'));
            thead.appendChild(tr);
            table.appendChild(thead);

            // Header
            for (var i = 0; i < strategies.length; i++) {
                var th = document.createElement('th');
                th.appendChild(document.createTextNode(strategies[i]));
                th.setAttribute('style', 'text-align: right');
                tr.appendChild(th);
            }

            var tbody = document.createElement('tbody');
            table.appendChild(tbody);

            // Content
            for (var n = 0; n < games.length; n++) {
                tr = document.createElement('tr');
                td = document.createElement('td');
                td.appendChild(document.createTextNode(games[n]));
                tr.appendChild(td);
                for (var i = 0; i < strategies.length; i++) {
                    var value = data.filter(function (d) {
                        return d.game == games[n] && d.strategy == strategies[i];
                    })[0].iterations;
                    td = document.createElement('td');
                    td.appendChild(document.createTextNode(value));
                    td.setAttribute('style', 'text-align: right');
                    tr.appendChild(td);
                }

                tbody.appendChild(tr);
            }

            table.setAttribute('class', 'striped');
            divtable.appendChild(table);
        }

        function fillResultsTable(data) {
            var strategies = getStrategies(data);
            var games = getGames(data);

            var divtable = document.getElementById('result_table');
            var table = document.createElement('table');
            var thead = document.createElement('thead');
            var tr = document.createElement('tr');

            while (divtable.hasChildNodes()) {
                divtable.removeChild(divtable.lastChild);
            }

            tr.appendChild(document.createElement('th'));
            thead.appendChild(tr);
            table.appendChild(thead);

            var th = document.createElement('th');
            th.appendChild(document.createTextNode('Result (odd)'));
            th.setAttribute('style', 'text-align: center');
            tr.appendChild(th);

            var tbody = document.createElement('tbody');
            table.appendChild(tbody);

            // Content
            for (var n = 0; n < games.length; n++) {
                tr = document.createElement('tr');
                tbody.appendChild(tr);

                td = document.createElement('td');
                b = document.createElement('b');
                td.appendChild(b);
                b.appendChild(document.createTextNode(games[n]));
                td.setAttribute('style', 'vertical-align:top');
                tr.appendChild(td);

                td = document.createElement('td');
                tr.appendChild(td);

                var innerTable = document.createElement('table');
                var innerTbody = document.createElement('tbody');
                td.appendChild(innerTable);
                innerTable.appendChild(innerTbody);

                for (var i = 0; i < strategies.length; i++) {
                    tr = document.createElement('tr');
                    innerTbody.appendChild(tr);

                    var value = data.filter(function (d) {
                        return d.game == games[n] && d.strategy == strategies[i];
                    })[0].odd;

                    td = document.createElement('td');
                    td.appendChild(document.createTextNode(strategies[i]));
                    tr.appendChild(td);

                    td = document.createElement('td');
                    td.appendChild(document.createTextNode(String(value).replace(/,/g, ', ')));
                    td.setAttribute('style', 'text-align: right');
                    tr.appendChild(td);
                }
            }

            table.setAttribute('class', 'striped');
            divtable.appendChild(table);
        }

        function fillPerformanceTable(data) {
            var strategies = getStrategies(data);
            var games = getGames(data);

            var divtable = document.getElementById('timing_table');
            var table = document.createElement('table');
            var thead = document.createElement('thead');
            var tr = document.createElement('tr');

            while (divtable.hasChildNodes()) {
                divtable.removeChild(divtable.lastChild);
            }

            tr.appendChild(document.createElement('th'));
            thead.appendChild(tr);
            table.appendChild(thead);

            // Header
            for (var i = 0; i < strategies.length; i++) {
                var th = document.createElement('th');
                th.appendChild(document.createTextNode(strategies[i]));
                th.setAttribute('style', 'text-align: right');
                tr.appendChild(th);
            }

            var tbody = document.createElement('tbody');
            table.appendChild(tbody);

            // Content
            for (var n = 0; n < games.length; n++) {
                tr = document.createElement('tr');
                var td = document.createElement('td');
                td.appendChild(document.createTextNode(games[n]));
                tr.appendChild(td);
                for (var i = 0; i < strategies.length; i++) {
                    var value = data.filter(function (d) {
                                return d.game == games[n] && d.strategy == strategies[i];
                            })[0].duration / 100000;
                    td = document.createElement('td');
                    td.appendChild(document.createTextNode(value.toFixed(4) + " ms"));
                    td.setAttribute('style', 'text-align: right');
                    tr.appendChild(td);
                }

                tbody.appendChild(tr);
            }

            table.setAttribute('class', 'striped');
            divtable.appendChild(table);
        }

        function generateCheckBoxes(data) {

            var games = getGames(data);
            var sel1 = document.getElementById('sel1');
            var sel2 = document.getElementById('sel2');
            var sel3 = document.getElementById('sel3');

            // Clear all children
            while (sel1.hasChildNodes()) {
                sel1.removeChild(sel1.lastChild);
            }
            while (sel2.hasChildNodes()) {
                sel2.removeChild(sel2.lastChild);
            }
            while (sel3.hasChildNodes()) {
                sel3.removeChild(sel3.lastChild);
            }

            var bucket = 1;
            for (var i = 0; i < games.length; i++) {
                var p = document.createElement('p');

                if (bucket == 1) {
                    sel1.appendChild(p);
                } else if (bucket == 2) {
                    sel2.appendChild(p);
                } else {
                    sel3.appendChild(p);
                    bucket = 0;
                }

                bucket++;

                var input = document.createElement('input');
                input.setAttribute('type', 'checkbox');
                input.setAttribute('id', games[i]);
                input.setAttribute('checked', 'checked');
                input.onclick = chkChanged;
                p.appendChild(input);

                var label = document.createElement('label');
                label.setAttribute('for', games[i]);
                label.appendChild(document.createTextNode(games[i]));
                p.appendChild(label);
            }
        }
        var checkboxesChecked = [];
        function getCheckedBoxes() {
            var checkboxes = document.getElementById('selectionForm').getElementsByTagName('input');
            checkboxesChecked = [];
            // loop over them all
            for (var i = 0; i < checkboxes.length; i++) {
                // And stick the checked ones onto an array...
                if (checkboxes[i].checked) {
                    checkboxesChecked.push(checkboxes[i].id);
                }
            }

            // Return the array if it is non-empty, or null
            return checkboxesChecked.length > 0 ? checkboxesChecked : null;
        }
        function chkChanged() {
            graphResize();
        }
    </script>

    <style>

        .axis path,
        .axis line {
            fill: none;
            stroke: #000;
            shape-rendering: crispEdges;
        }

        .d3-tip {
            line-height: 1;
            font-weight: bold;
            padding: 12px;
            background: rgba(0, 0, 0, 0.8);
            color: #fff;
            border-radius: 2px;
        }

        /* Creates a small triangle extender for the tooltip */
        .d3-tip:after {
            box-sizing: border-box;
            display: inline;
            font-size: 10px;
            width: 100%;
            line-height: 1;
            color: rgba(0, 0, 0, 0.8);
            content: "\25BC";
            position: absolute;
            text-align: center;
        }

        /* Style northward tooltips differently */
        .d3-tip.n:after {
            margin: -1px 0 0 0;
            top: 100%;
            left: 0;
        }
    </style>

</head>
<body onresize="graphResize()">
<!--Import jQuery before materialize.js-->
<script type="text/javascript" src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
<script type="text/javascript" src="js/materialize.min.js"></script>

<div class="navbar-fixed" >
<nav class="blue darken-1">
    <div class="container nav-wrapper">
        <a href="#" class="brand-logo">Parity Game Dashboard</a>
        <ul id="nav-mobile" class="right hide-on-med-and-down">
            <a class="waves-effect waves-light btn modal-trigger blue darken-2" href="#modal1">Data selection</a>
            <!--<li><a href="sass.html">Sass</a></li>
            <li><a href="badges.html">Components</a></li>
            <li><a href="collapsible.html">JavaScript</a></li>-->
        </ul>
    </div>
</nav>
</div>

<div class="container">

    <!-- Modal Structure -->
        <div id="modal1" class="modal bottom-sheet">
            <div class="container">
            <div class="modal-content">
                <form id="selectionForm" action="#">
                    <div class="row">
                        <div id="sel1" class="col s4"></div>
                        <div id="sel2" class="col s4"></div>
                        <div id="sel3" class="col s4"></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <a href="#!" class=" modal-action modal-close waves-effect waves-green btn-flat">Agree</a>
            </div>
        </div>
    </div>



    <div id="d3measure" class="center-align">
        <svg id="graph"/>
    </div>

    <h3 class="blue-text text-darken-1">Statistics</h3>
    <div id="statistics_table" class="striped" style="margin-top: 20px">

    </div>

    <h3 class="blue-text text-darken-1">Iterations</h3>
    <div id="iteration_table" class="striped" style="margin-top: 20px">

    </div>

    <h3 class="blue-text text-darken-1">Performance</h3>
    <div id="timing_table" class="striped" style="margin-top: 20px">

    </div>

    <h3 class="blue-text text-darken-1">Results</h3>
    <div id="result_table" class="striped" style="margin-top: 20px">

    </div>

</div>

<script>

    $(document).ready(function(){
// the "href" attribute of .modal-trigger must specify the modal ID that wants to be triggered
        $('.modal-trigger').leanModal();
    });

    var loaded = false;

    function graphResize() {
        var mwidth = document.getElementById('d3measure').clientWidth;
        var mheight = (mwidth / 16) * 9;

        var margin = {top: 20, right: 20, bottom: 300, left: 80},
                width = mwidth - margin.left - margin.right,
                height = mheight - margin.top - margin.bottom;

        var x0 = d3.scale.ordinal()
                .rangeRoundBands([0, width], .1);

        var x1 = d3.scale.ordinal();

        var y = d3.scale.pow().exponent(0.5)
                .range([height, 0]);

        var color = d3.scale.category10();

        //var color = d3.scale.ordinal()
        //        .range(["#d7191c", "#fdae61", "#ffffbf", "#abd9e9", "#2c7bb6"]);

        var xAxis = d3.svg.axis()
                .scale(x0)
                .orient("bottom");

        var yAxis = d3.svg.axis()
                .scale(y)
                .orient("left")
                .tickFormat(d3.format(".2s"));

        var tip = d3.tip()
                .attr('class', 'd3-tip')
                .offset([-10, 0])
                .html(function (d) {
                    return "<strong>Iterations:</strong> <span style='color:red'>" + d.iterations + "</span>";
                })

        var svg = d3.select("#graph")
                .selectAll("*").remove();

        var svg = d3.select("#graph")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        svg.call(tip);

        d3.json("/results", function (error, data) {
            if (error) throw error;

            if (!loaded) {
                loaded = true;
                generateCheckBoxes(data.results);
            }

            var checkBoxes = getCheckedBoxes();
            fillStatistics(data.statistics);
            fillIterationTable(data.results);
            fillPerformanceTable(data.results);
            fillResultsTable(data.results);

            var strategies = getStrategies(data.results);
            var games = getGames(data.results).filter(function (d) {
                for (var i = 0; i < checkBoxes.length; i++) {
                    if (d == checkBoxes[i]) {
                        return true;
                    }
                }
                return false;
            });

            x0.domain(games);
            x1.domain(strategies).rangeRoundBands([0, x0.rangeBand()]);
            y.domain([0, d3.max(data.results, function (d) {
                return d.iterations;
            })]);

            svg.append("g")
                    .attr("class", "x axis")
                    .attr("transform", "translate(0," + height + ")")
                    .call(xAxis)
                    .selectAll("text")
                    .style("text-anchor", "end")
                    .attr("dx", "-.8em")
                    .attr("dy", ".15em")
                    .attr("transform", "rotate(-65)");

            svg.append("g")
                    .attr("class", "y axis")
                    .call(yAxis)
                    .append("text")
                    .attr("transform", "rotate(-90)")
                    .attr("y", 6)
                    .attr("dy", ".71em")
                    .style("text-anchor", "end")
                    .text("Iterations");

            var state = svg.selectAll(".state")
                    .data(games)
                    .enter().append("g")
                    .attr("class", "state")
                    .attr("transform", function (d) {
                        return "translate(" + x0(d) + ",0)";
                    });

            state.selectAll("rect")
                    .data(function (d) {
                                var game = d;
                                return data.results.filter(function (d) {
                                    return d.game == game;
                                })
                            }
                    )
                    .enter().append("rect")
                    .attr("width", x1.rangeBand())
                    .attr("x", function (d) {
                        return x1(d.strategy);
                    })
                    .attr("y", function (d) {
                        return y(d.iterations);
                    })
                    .attr("height", function (d) {
                        return height - y(d.iterations);
                    })
                    .style("fill", function (d) {
                        return color(d.strategy);
                    })
                    .on('mouseover', tip.show)
                    .on('mouseout', tip.hide);

            var legend = svg.selectAll(".legend")
                    .data(strategies.slice().reverse())
                    .enter().append("g")
                    .attr("class", "legend")
                    .attr("transform", function (d, i) {
                        return "translate(0," + i * 20 + ")";
                    });

            legend.append("rect")
                    .attr("x", 30)
                    .attr("width", 18)
                    .attr("height", 18)
                    .style("fill", color);

            legend.append("text")
                    .attr("x", 50)
                    .attr("y", 9)
                    .attr("dy", ".35em")
                    .style("text-anchor", "start")
                    .text(function (d) {
                        return d;
                    });
        });
    }

    graphResize();

</script>
</body>
